<html>
	<head>
		<link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css' />
		<link href='{{=URL("css.css")}}' rel='stylesheet' type='text/css' />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.js"></script>
		<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript">
		$(document).ready(function() {
			$('.expand').on('click', function(e) {
				var ssec_div = $(this).parent().parent();
				if(ssec_div.hasClass('expanded')) {
					$(this).html('+');
					ssec_div.removeClass('expanded');
				} else {
					$(this).html('&#8722;');
					ssec_div.addClass('expanded');
				}
			});

			$('#sec_container').sortable({
				items: '.page',
				change: function(event, ui) { 
					console.log(ui.placeholder);
					var placeholder_canvas = $(ui.placeholder).parents('.pages_canvas');
					placeholder_canvas.css('width', (placeholder_canvas.children('.page').length * 14 + 4.5) + 'em');
				},
				placeholder: 'page-placeholder',
				stop: function (event, ui) {
						moved_page = $(ui.item);
						var moved_page_number = moved_page.index() + 1;
						var moved_parent_section = moved_page.parents('.ssec')
						if (moved_parent_section.length != 0) {
							var moved_parent_section_id = moved_parent_section.attr('id').substring(3);
						}
						var moved_page_id = moved_page.attr('pageid');
						console.log('Page moved: section ' + moved_parent_section_id + ' number ' + moved_page_number);
						$.get('default/call/run/move_page', 
							{ page_id: moved_page_id, section_id: moved_parent_section_id, page_number: moved_page_number });

			       	}
			}).disableSelection();

			$('.page').on('dblclick', function(e) {
				window.open('{{=URL(c='default', f='page')}}' + '/' + $(this).attr('pageid'));
			});

			var new_page_num;
			var new_page_title;
			var new_page_section;
			$('.before').on('click', function(e) {
					$('.new_page_dialog input[name="page_num"]').val($(this).parent('.page').index() + 1);
					$('.new_page_dialog input[name="section"]').val($(this).closest('.sec, .ssec').attr('id').substring(3));
					$('.new_page_dialog').offset({left: e.pageX, top: e.pageY}).fadeIn();
					$('.new_page_dialog input').focus();
					});
			$('.at_end').on('click', function(e) {
					$('.new_page_dialog input[name="page_num"]').val($(this).siblings().length);
					$('.new_page_dialog input[name="section"]').val($(this).closest('.sec, .ssec').attr('id').substring(3));
					$('.new_page_dialog').offset({left: e.pageX, top: e.pageY}).fadeIn();
					$('.new_page_dialog input').focus();
					});
			$('.new_page_dialog form').submit(function(e) {
				e.preventDefault();
				console.log('default/call/run/create_page?' + $(this).serialize());
				$.ajax({
					url: 'default/call/run/create_page?' + $(this).serialize(),
					dataType: 'json',
					success: function (data) { 
					console.log(data['title']);
					console.log('#sec' + data['section'] + ' .page:eq(' + ($('.new_page_dialog input[name="page_num"]').val() - 1) + ')');
						$('#sec' + data['section'] + ' .page:eq(' + ($('.new_page_dialog input[name="page_num"]').val() - 2) + ')')
							.after('<div class="page" pageid="' + data['page_id'] + '">' + data['title'] + '<div class="add_page before"></div></div>');
					       	},
				});
				$('.new_page_dialog').hide();
			});
			$('.new_page_dialog').hide();
			

		});
			
	</script>
	<style>
		.drop-page {
			width: 5em;
			height: 5em;
			background-color: red;
		}
	</style>
	</head>
	<body>
                <header>
                	<h1>LabBook - Alastair Mailer</h1>
		</header>
		<div id="sec_container">
		{{for section in labbook['sections']:}}
		<div class="sec">
			<div class="sec_info">
				<div class="title">{{=section['title']}}</div>
				<div class="details">{{=len(section['subsections'])}} subsection(s)</div>
			</div>
			<div class="ssec_container">
				{{for subsection in section['subsections']:}}
				<div class="ssec" id="{{=subsection['id']}}">
					<div class="ssec_info">
						<div class="expand">+</div>
						<div class="title">{{=subsection['title']}}</div>
						<div class="details">{{=len(subsection['pages'])}} page(s)</div>
					</div>
					<div class="pages_scrollhide">
						<div class="pages_scroller">
							<div class="pages_canvas">
								{{for page in sorted(subsection['pages'], key=lambda pg: pg['number']):}}
								<div class="page" pageid="{{=page['id']}}">
									{{=page['title']}}
									<div class="add_page before"></div>
								</div>
								{{pass}}
								<div class="add_page at_end"></div>
							</div>
						</div>
					</div>
				</div>
				{{pass}}
			</div>
		</div>
		{{pass}}
	</div>
	<div class="new_page_dialog">
		<form action="default/call/run/create_page">
			<fieldset>
				<legend>Add New Page</legend>
				<label for="new_page_title">Page title:</label>
				<input type="text" name="title" />
				<input type="hidden" name="page_num" />
				<input type="hidden" name="section" />
				<br />
				<br />
				<button type="submit">Add Page</button>
				<button>Cancel</button>
			</fieldset>
		</form>
	</div>
	</body>
</html>
