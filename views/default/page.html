<head>
{{response.files.append("http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js")}} 
{{response.files.append("http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.js")}}
{{response.files.append("http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/base/jquery-ui.css")}}
<!--
           
            -->
{{include 'web2py_ajax.html'}}
<link rel="stylesheet" type="text/css" href={{=URL('css','page_layout.css', vars=dict(id=page.id))}} />
<script type="text/javascript" src="{{=URL('static/js','protect_text.js')}}"></script>
<script type="text/javascript" src="{{=URL('static/js','jquery.jeditable.js')}}"></script>
<script type="text/javascript" src="{{=URL('static/js', 'crossbox.js')}}"></script>
<script type="text/javascript">
var buttonAddContainer = $('<button type="button" id="mknewbox" class="side_button"><img src={{=URL("static/images","Crystal_Project_New_window.png")}} class="side_button" style="width:90%;" /></button>');
var buttonRemoveContainer = $('<button type="button" id="delbox" class="side_button"><img src={{=URL("static/images","Crystal_Project_View_remove.png")}} class="side_button" style="width:90%;" /></button>');


function handleDragEnter(event) {
    event.stopPropagation();
    event.preventDefault();
    crossBoxOver = this;
    crossBoxResizeAndPosition(this.id);
    crossBoxShow();
}

function handleDrop(event) {
    event.stopPropagation();
    event.preventDefault();
    var box_id = crossBoxOver.id.substr(1);
    var contentFile = event.dataTransfer.files[0];
    var fd = new FormData();
    fd.append("page_id", "{{=page.id}}");
    fd.append("box_id", box_id);
    fd.append("contentFile", contentFile);
    fd.append("contentFileName", contentFile.name);
    fd.append("contentFileType", contentFile.type);
    fd.append("contentFileSize", contentFile.size);
    xhr = new XMLHttpRequest();
    xhr.open("POST", "{{=URL('call/run/upload_content')}}" , true);
    xhr.send(fd);
    crossBoxOver.innerHTML = "Content updated - refresh to see!"
}

function handleDragLeave(event) {
    //console.log(this.id + " called drag leave");
}

function handleUpdateTitle(value, settings) { 
   jQuery.post('{{=URL("call/run/update_title")}}', { page_id:{{=page.id}}, title_content:value }, function(data){ value = data.title_content; console.log("title update : ");console.log(data); }, "json"); 
    return(value);
}   

function handleMoveContainer(event, ui) {
    jQuery.post('{{=URL("call/run/move_box")}}', { id:$(ui.helper).attr("id").replace('c',''), x:$(ui.position).attr("left")/pxPerem, y:$(ui.position).attr("top")/pxPerem }, function(data){ console.log("move container : ");console.log(data); }, "json");
}

function handleResizeContainer(event, ui) {
    jQuery.post('{{=URL("call/run/resize_box")}}', { id:$(ui.helper).attr("id").replace('c',''), w:$(ui.size).attr("width")/pxPerem, h:$(ui.size).attr("height")/pxPerem }, function(data){ console.log("resize container : ");console.log(data); }, "json");
}

function handleCreateContainer(new_cont) {
    console.log(new_cont);
    var dims = { x: Math.min(new_cont['x1'],new_cont['x2']), y: Math.min(new_cont['y1'],new_cont['y2']), w: Math.abs(new_cont['x2']-new_cont['x1']), h: Math.abs(new_cont['y2']-new_cont['y1']) };
    jQuery.post('{{=URL("call/run/new_box")}}', { page_id:new_cont['pid'], x:dims['x']/pxPerem, y:dims['y']/pxPerem, w:dims['w']/pxPerem, h:dims['h']/pxPerem }, function(data){  
        $("#content_area").append( "<div class='cbox snapable' id='c"+data.new_id+"' >New content box created by javascript.</div>" );   
        $("div#c" + data.new_id).css({ 
            'top':dims['y']+'px',
            'left':dims['x']+'px',
            'width':dims['w']+'px',
            'height':dims['h']+'px'
        });
        defineContainerMobile($("div#c" + data.new_id));           
        console.log("create container : ");console.log(data);             
    }, "json"); 
}

/*
function disableSelection(target){
    if (typeof target.onselectstart!="undefined") {//IE route
        target.onselectstart=function(){return false}
    } else if (typeof target.style.MozUserSelect!="undefined") {//Firefox route
        target.style.MozUserSelect="none"
    } else {//All other route (ie: Opera)
        target.onmousedown=function(){return false}
    }
    target.style.cursor = "default"
}
*/

function defineContainerMobile(target) {
    target.draggable({    
        snap: ".cbox",
        snapTolerance: 5,
        snapMode: "outer",
        containment: "parent",
        stop: function(event, ui) { handleMoveContainer(event, ui); }
    }).resizable({ 
        containment: "parent",       
        stop: function(event, ui) { handleResizeContainer(event, ui); }
    }).click( function() {
        if ($("button#delbox").hasClass("selected")) {
            jQuery.post('{{=URL("call/run/del_box")}}', { box_id:$(this).attr("id").replace('c','') }, function(data){ console.log("remove container : ");console.log(data); }, "json");
            $(this).detach();
            setContainersMobile();
            $(".selected").removeClass("selected");
        }
    });  
}

function unsetContainersMobile() {
    $(".cbox").draggable("option", "disabled", true).resizable("option", "disabled", true);
}
function setContainersMobile() {
    $(".cbox").draggable("option", "disabled", false).resizable("option", "disabled", false);
}
   
var pxPerem = false;
$(document).ready(function(){
    pxPerem = $("div.page").width()/70.0; 
    var new_cont = { 'pid': {{=page.id}}, x1: "", y1: "", x2: "", y2: ""}; 
       
 
    $("#main_page").disableTextSelect();
    defineContainerMobile($(".cbox"));    
    
    //Doubdle click to edit Press enter to save changes. Press Esc to cancel them.
    $("#title_bar").bind('focusin', function() { $("#main_page").enableTextSelect() } ).bind('focusout', function() { $("#main_page").disableTextSelect() } ).editable(handleUpdateTitle, { 
        tooltip   : "DoubleClick to edit...",
        event     : "dblclick"
    });  
       
    $('#side_bar_l').append(buttonAddContainer,buttonRemoveContainer);
    
    $("button#mknewbox").click(function(){ 
        if (!$(this).hasClass("selected")) {       
            $(".selected").removeClass("selected");
            $(this).addClass("selected");
            unsetContainersMobile();
        } else {            
            setContainersMobile();
            $(".selected").removeClass("selected");
        }
    });   
    
    $("button#delbox").click(function(){ 
        if (!$(this).hasClass("selected")) {       
            $(".selected").removeClass("selected");
            $(this).addClass("selected");
            unsetContainersMobile();
        } else {            
            setContainersMobile();
            $(".selected").removeClass("selected");
        }
    });
     
    $("#content_area").mousedown(function(e){    
        if ($("button#mknewbox").hasClass("selected")) {   
            new_cont['x1'] = (e.pageX - $("div.content_area").offset().left);
            new_cont['y1'] = (e.pageY - $("div.content_area").offset().top);
            if (!(new_cont['x1'] > 0 && new_cont['y1'] > 0 && new_cont['x1'] < $("div.content_area").width() && new_cont['y1'] < $("div.content_area").height()))  {
                new_cont['x1'] = -1;
                new_cont['y1'] = -1;
            }
        }
    }).mouseup(function(e){
        if ($("button#mknewbox").hasClass("selected")) { 
            new_cont['x2'] = (e.pageX - $("div.content_area").offset().left);
            new_cont['y2'] = (e.pageY - $("div.content_area").offset().top); 
            if (!(new_cont['x2'] > 0 && new_cont['y2'] > 0 && new_cont['x2'] < $("div.content_area").width() && new_cont['y2'] < $("div.content_area").height())) {
                new_cont['x2'] = -1;
                new_cont['y2'] = -1;
            }            
            if (new_cont['x1'] > 0 && new_cont['x2'] > 0 && new_cont['y1'] > 0 && new_cont['y2'] > 0) {
                handleCreateContainer(new_cont);  
                $(".selected").removeClass("selected");
                setContainersMobile();           
                new_cont['x1'] = -1;
                new_cont['y1'] = -1; 
                new_cont['x2'] = -1;
                new_cont['y2'] = -1;
            }
        }           
    });
    
    $(".cbox").each(function(index) {   
        $(this).on('dragenter', handleDragEnter);
        $(this).on('drop', handleDrop);
        $(this).on('dragleave', handleDragLeave);
    });
    
    $('#content_area').append(getCrossBox());
    
});
</script>
</head>
<body class="page">
    <div id="main_page" class="page">
        {{=DIV(SPAN(page.title, _id="title_bar", _class="title_bar"), _class="title_bar")}}
        {{=DIV(_id="side_bar_l", _class="side_bar")}}
        <div id="content_area" class="content_area">
            {{for tbox in boxes:}}        
                {{=DIV(contents[tbox.id], _id="c%(id)s"%dict(id=tbox.id), _class="cbox")}}
            {{pass}}
        </div>
    </div>
<!--    <button type="button" id="mknewbox">Create box</button>
    <button type="button" id="delbox">Delete box</button> -->
</body>
